class GW2Tooltips{constructor(){this.correctStats={Power:"Power",Precision:"Precision",CritDamage:"Ferocity",ConditionDamage:"Condition Damage",Healing:"Healing Power",ConditionDuration:"Expertise",BoonDuration:"Concentration",Toughness:"Toughness",Vitality:"Vitality"},this.correctItemStats={Power:"Power",Precision:"Precision",CritDamage:"Ferocity",ConditionDamage:"Condition Damage",HealingPower:"Healing Power",ConditionDuration:"Expertise",BoonDuration:"Concentration",Healing:"Healing Power",Toughness:"Toughness",Vitality:"Vitality"},this.correctSkillStats={Power:"Power",Precision:"Precision",CritDamage:"Ferocity",ConditionDamage:"Condition Damage",HealingPower:"Healing Power",ConditionDuration:"Expertise",BoonDuration:"Concentration",Healing:"Healing Power",Toughness:"Toughness",Vitality:"Vitality"},this.keywords=["Signet Passive:","Signet","Legendary Dragon","Legendary Assassin","Legendary Demon","Legendary Dwarf","Legendary Centaur","Legendary Renegade","Citadel Order","Legendary Alliance","Spirit Weapon","Consecration","Meditation","Shout","Virtue","Symbol","Activate:","Final Charge","Ward","Spirit","Beast","Trap","Survival","Stealth Attack","Deception","Venom","Trick","Dual Wield","Turret","Gadget","Elixir","Engineering Kit","Gyro","Exceed","Mech Command","Stance","Banner","Physical","Rage","Burst","Armament","Minion","Spectral","Well","Corruption","Punishment","Shade","Mark","Reaper's Shroud","Shroud","Glyph","Conjure","Arcane","Cantrip","Dual Attack","Overload","Augment","Phantasm","Shatter","Mantra","Manipulation","Clone","Glamour","Psionic","Bladesong"],this.toolTipBuffs=["Aegis","Might","Fury","Protection","Swiftness","Regeneration","Vigor","Quickness","Stability","Superspeed","Retaliation","Resistance","Reflection","Alacrity","Distortion","Bleeding","Torment","Burning","Crippled","Immobile","Chilled","Slow","Poison","Vulnerability","Weakness","Blind","Fear","Confusion","Taunt"],this.ccs={Float:100,"Stone Duration":100,Morphed:100,Knockdown:100,"Initial Target Knockdown Time":100,Stun:100,Daze:100,"Initial Impact Daze":100,"Foe Launch Distance":332,single:{Launch:{0:232,29941:332,5813:332,12380:332},Pull:150,Knockback:150,"Knockback Distance":150,"Knockback on Landing":232,"Maximum Knockback Distance":150},ids:{9144:150,9128:750,30273:300,30628:150,13099:150,5683:150,9195:150,10363:150,29519:600}},this.soft_ccs={Fear:100,Taunt:75,Immobile:50,Slow:50,Chilled:33,Blinded:20,Weakness:20,Crippled:15},this.generatedTooltips=[],this.contexts=[],this.tooltip=tUtils.newElement("div","tooltipWrapper"),document.body.appendChild(this.tooltip)}processDefianceDmg(e,t){let i={},n=0;Object.keys(this.ccs.ids).includes(e.dataset.id)&&(n+=this.ccs.ids[e.dataset.id]);for(var s=0;s<t?.length;s++){let o=t[s].duration??0;const r={Stun:"Daze",Daze:"Stun"};if(Object.keys(i).includes(t[s].text)||12508==e.dataset.id&&"Stun"==t[s].text&&i?.Daze||12508==e.dataset.id&&"Daze"==t[s].text&&i?.Stun){let e=i[Object.keys(r).includes(t[s].text)?r[t[s].text]:t[s].text]?.duration??0;if(e>=o)continue;o-=e}var l="";Object.keys(this.ccs).includes(t[s].text)?l=t[s].text:Object.keys(this.ccs).includes(t[s].status)&&(l=t[s].status),l?n+=Math.max(100,this.ccs[l]*o):(Object.keys(this.ccs.single).includes(t[s].text)?l=t[s].text:Object.keys(this.ccs.single).includes(t[s].status)&&(l=t[s].status),"Launch"==l?this.ccs.single[l][e.dataset.id]?n+=this.ccs.single[l][e.dataset.id]:n+=this.ccs.single[l][0]:l&&(n+=this.ccs.single[l])),i[t[s].text]=t[s]}if(n){let t=document.createElement("te");t.classList.add("defiance"),t.innerHTML=tUtils.newImg("https://render.guildwars2.com/file/9F19DB1D3E1629390F2360F2D866651BBC0F6155/1938788.png","iconmed")+"<tem>Defiance Break: "+n+"</tem> ",e.appendChild(t)}}getFact(e,t){if(null!=e)for(var i=0;i<e.length;i++)if(e[i].text===t)return e[i];return null}getFacts(e,t){for(var i=[],n=0;n<e.length;n++)e[n].type===t&&i.push(e[n]);return i}getRechargeWithFraction(e){var t=tUtils.newElement("div"),i=(e=(Math.round(4*e)/4).toFixed(2).toString()).split(".")[0],n=parseFloat(e.split(".")[1]);if(n/=100,"0"!=i&&(t.innerHTML=i),0==n)return t;var s=tUtils.getFractionFromDecimal(n);return t.innerHTML+="<span class='fraction'>"+s.numerator+"/"+s.denominator+"</span>",t}processBasicTooltipInfo(e){var t,i=document.createElement("tet"),n=e.name,s=e?.slot??null;s&&"Major"!=s&&"Minor"!=s||(s=""),s&&(s=s.replace("_"," "),"Profession"==e?.type&&(s=s.replace("Downed","Weapon")),e?.weapon_type&&"None"!==e?.weapon_type&&(s=s.replace("Weapon",e.weapon_type)),s="<tes>("+s+')</tes><div class="flexbox-fill"></div>'),null!=e.facts&&(t=this.getFact(e.facts,"Recharge")),i.innerHTML=null!=t?"<teb>"+n+"</teb>"+s+"<ter>"+(null!=e.traitedrecharge&&e.traitedrecharge>1?this.getRechargeWithFraction(e.traitedrecharge).innerHTML:this.getRechargeWithFraction(t.value).innerHTML)+tUtils.newImg(t.icon,"iconsmall")+"</ter>":"<teb>"+n+"</teb>"+s;var l=document.createElement("ted");return l.innerHTML=null==e.description?"":this.highlightKeywords(e.description),i.outerHTML+l.outerHTML}processFact(e){var t=document.createElement("te");if(null==e)return t;switch(1==e.traited&&(t.className="traited"),e.type){case"PrefixedBuff":t.innerHTML+=tUtils.newImg(e.prefix.icon,"iconmed")+tUtils.newImg(e.icon,"iconmed")+"<tem>"+(null!=e.modifier?100*e.modifier+"%":"")+e.status+" "+(e.duration>0?"("+e.duration+"s) ":"")+e.description+"</tem>",e.apply_count>1&&t.appendChild(tUtils.newElement("div","buffcount prefixed",e.apply_count));break;case"Percent":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+e.text+": "+e.percent+"%</tem>";break;case"Duration":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.text+": "+e.duration+"</tem>";break;case"DefianceDamage":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.text+": "+e.description+"</tem>",t.classList.add("defiance");break;case"Damage":null==e.hit_count||e.hit_count<2?t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.text+": "+Math.round(266*e.dmg_multiplier)+"</tem>":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.text+": ("+e.hit_count+"x) "+Math.round(266*e.dmg_multiplier*e.hit_count)+"</tem>";break;case"Buff":let s="Buff"==e?.type?"Boon":"Condition";0!=e.duration?void 0!==e.duration?t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.status+" ("+this.getRechargeWithFraction(e.duration).innerHTML+"s) "+e.description+"</tem>":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+s+" Removed</tem> ":0==e.traited||null==e.traited||null!=e.apply_count?t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.description+"</tem>":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+s+" Removed</tem>",e.apply_count>1&&t.appendChild(tUtils.newElement("div","buffcount",e.apply_count));break;case"BuffConversion":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> Gain "+this.correctSkillStats[e.target]+" Based on a Percentage of "+this.correctSkillStats[e.source]+": "+e.percent+"%</tem>";break;case"AttributeAdjust":null==e.text||"Attribute Adjust"==e.text?t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+this.correctSkillStats[e.target]+": "+e.value+"</tem>":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+e.text+": "+e.value+"</tem>";break;case"Time":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.text+": "+e.duration+"s</tem>";break;case"Distance":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+e.text+": "+e.distance+"</tem>";break;case"Range":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> Range: "+e.value+"</tem>";break;case"Number":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+e.text+": "+e.value+"</tem>";break;case"NoData":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+e.text+"</tem>";break;case"ComboField":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+e.text+": "+e.field_type;break;case"ComboFinisher":var i="",n="";null!=e.percent&&100!=e.percent&&(i="("+e.percent+"% Chance)"),"Projectile"==e.finisher_type&&(n="Physical"),t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>"+e.text+": "+n+" "+e.finisher_type+" "+i;break;case"StunBreak":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem>Breaks Stun</tem>";break;case"Unblockable":t.innerHTML+=tUtils.newImg("https://render.guildwars2.com/file/BA65F2F5A073EB4BCC79085916B978DC0B096A0B/2248876.png","iconmed")+"<tem>Unblockable</tem>";break;case"Custom":t.innerHTML+=tUtils.newImg(e.icon,"iconmed")+"<tem> "+(e.status?e.status+": ":"")+e.description+"</tem>",e.apply_count>1&&t.appendChild(tUtils.newElement("div","buffcount",e.apply_count));break}return t}processFacts(e,t){for(var i=[],n=0;n<t.length;n++){var s=this.processFact(t[n]);i.includes(s.innerHTML)||(i.push(s.innerHTML),"<br>"!=s.innerHTML&&e.appendChild(s))}}checkContextDisplay(e){if("Buff"==e.type&&!this.toolTipBuffs.includes(e.status))return!1;if("PrefixedBuff"==e.type)return!1;if("Distance"==e.type&&"Radius"!=e.text)return!1;if("BuffConversion"==e.type)return!1;if("AttributeAdjust"==e.type&&"Healing"!=e.target&&("Healing"!=e.target&&"Power"!=e.target||null==e.text||!e.text.includes("Life Siphon")))return!1;if(null!=e.text){if(e.text.includes("Increase"))return!1;if(e.text.includes("Recharge"))return!1;if(e.text.includes("Duration"))return!1;if(e.text.includes("Gain"))return!1;if(e.text.includes("Reduc"))return!1;if(e.text.includes("Stacks"))return!1;if(e.text.includes("Additional"))return!1;if(e.text.includes("Bonus"))return!1;if(e.text.includes("Threshold"))return!1;if("Combat Only"==e.text)return!1;if("Percent"==e.type&&!Number.isInteger(e.percent)&&e.percent<2)return!1}return!0}checkDuplicateFact(e,t){if(null==t)return!1;for(var i=0;i<t.length;i++)if(JSON.stringify(e)==JSON.stringify(t[i]))return!0;return!1}checkSpecialNumberCase(e){if(!e?.text)return!1;if(e.text.includes("Threshold"))e.subtype="Threshold";else if(e.text.includes("Life Force"))e.subtype="LifeForce";else if(e.text.includes("Condition")||e.text.includes("Boon"))e.subtype="BuffManipulate";else if(e.text.includes("Targets"))e.subtype="Targets";else if(e.text.includes("Casts"))e.subtype="Casts";else if("Pulses"==e.text)e.subtype="Pulses";else if(e.text.includes("Damage")&&"Time"!=e.type&&!e.text.includes("Critical"))e.subtype="DamageMod";else if("Duration"==e.text)e.subtype="Duration";else if("Interval"==e.text)e.subtype="Interval";else if("Count Recharge"==e.text)e.subtype="CountRecharge";else{if(!e.text.includes("Reduced"))return!1;e.subtype="TimeReduced"}return!0}determineUnknownType(e){"Life Force Cost"==e.text&&(e.type="LifeForceCost")}orderFacts(e){if(null==e)return[];for(var t=[],i=["Custom","LifeForceCost","Damage","DamageMod","Lifesteal","Healing","PrefixedBuff","Buff","ConditionRemove","AttributeAdjust","BuffConversion","BuffManipulate","LifeForce","Percent","TimeReduced","Casts","Targets","Pulses","Threshold","Time","Duration","Interval","Number","CountRecharge","Distance","NoData","StunBreak","ComboField","ComboFinisher","Unblockable","Range","DefianceDamage"],n=0,s=0;s<e.length;s++)null!=e[s]&&(null!=e[s].type?e[s].subtype=e[s].type:this.determineUnknownType(e[s]),"Number"==e[s].type||"Percent"==e[s].type||"Time"==e[s].type?this.checkSpecialNumberCase(e[s]):"Healing"==e[s].text||"Healing"==e[s].target?e[s].subtype="Healing":null!=e[s].text&&e[s].text.includes("Life Siphon")?e[s].subtype="Lifesteal":"Buff"==e[s].type&&void 0===e[s].duration&&(e[s].subtype="ConditionRemove"));for(var l=0;l<i.length;l++){"AttributeAdjust"==i[l]&&(n=t.length);for(s=0;s<e.length;s++)null!=e[s]&&i.includes(e[s].type)&&e[s].subtype==i[l]&&(Object.keys(this.ccs).includes(e[s].text)?t.splice(n,0,e[s]):t.push(e[s]))}return[].concat(t)}getKeyword(e,t){if(null==e||null==e.description)return null;if(null!=e.specialkeywords&&null!=e.specialkeywords[t.specialization])return e.specialkeywords[t.specialization];if(null!=t.categories)for(var i=0;i<t.categories.length;i++)if(e.description.includes(t.categories[i])&&!new RegExp("\\bskill\\b").test(e.description))return t.categories[i];var n=null,s=(e?.description??"").split(" ");if(s.length<3)return null;if("s"==(n=s[2].toLowerCase())[n.length-1]&&(n=n.substring(0,n.length-1)),""==n)return null;var l=n.split(" ");for(i=0;i<l.length;i++)l[i].length>0&&(l[i]=l[i][0].toUpperCase()+l[i].substring(1,l[i].length));if(n=l.join(""),null!=e.skills)for(i=0;i<e.skills.length;i++)null==e.skills[i].categories||e.skills[i].categories.includes(n)||e.skills[i].categories.push(n);return n.charAt(0).toUpperCase()+n.slice(1)}getCategory(e){var t=[];if(null!=e.description){var i=e.description.split(".")[0];i.split(" ").length<=2&&t.push(i)}return t}applyContext(e,t){return null==t&&(t={traits:[],mode:2}),null==e.categories&&(e.categories=this.getCategory(e)),new Promise(((i,n)=>{var s=e.facts,l=[];null==e.traited_facts&&(e.traited_facts=[]);for(var o=[],r=0;r<e.traited_facts.length;r++){var a=e.traited_facts[r].requires_trait.toString();if(a!=e.id&&t.traits.includes(a)){if(null!=e.traited_facts[r].overrides?(s[e.traited_facts[r].overrides]=tUtils.jsonClone(e.traited_facts[r]),s[e.traited_facts[r].overrides].traited=!0):(s.push(tUtils.jsonClone(e.traited_facts[r])),s[s.length-1].traited=!0),l.includes(a))continue;null==gw2API.downloadedObjects["trait_"+a]&&o.push(a)}}gw2API.getAPIObjects("trait",o).then((n=>{for(var o=0;o<t.traits.length;o++){var r=gw2API.downloadedObjects["trait_"+t.traits[o]];if(null!=r.facts)for(var a=this.getKeyword(r,e),c=0;c<r.facts.length;c++){if("Recharge Reduced"==r.facts[c].text){for(var d,u,p=(r?.description??"").split("."),g=0;g<p.length;g++)p[g].includes("recharge")&&(d=g),p[g].includes(a)&&(u=g),"Weapon"==e.type&&p[g].includes(e.weapon_type)&&(u=g);var h=this.getFact(e.facts,"Recharge");null==h||d!=u||!e.categories.includes(a)&&"Weapon"!=e.type||(e.traitedrecharge=h.value*(1-r.facts[c].percent/100))}if(!l.includes(r.id.toString())&&!this.checkDuplicateFact(r.facts[c],s)&&this.checkContextDisplay(r.facts[c])&&(e.categories.includes(a)||null==a&&0==e.categories.length)&&null!=e.categories[0]&&(r?.description??"").split(".")[0].toLowerCase().includes(e.categories[0].toLowerCase()))if(null!=r.skills)r.description.includes(e.name)&&(s.push(tUtils.jsonClone(r.facts[c])),s[s.length-1].traited=!0);else{var m=(r?.description??"").split("@reminder>")[1];!s||null!=m&&m.includes(a.toLowerCase())||(s.push(tUtils.jsonClone(r.facts[c])),s[s.length-1].traited=!0)}}}i(s)}))}))}highlightKeywords(e,t){e=(e=(e=e.replace("Signet Active:","<teh><br>Signet Active:</teh>")).replace("Activate:","<teh><br>Activate:</teh>")).replace("c=@reminder","reminder");for(var i=0;i<this.keywords.length;i++)e=(e=(e=(e=e.replace(this.keywords[i]+" ","<teh>"+this.keywords[i]+" </teh>")).replace(this.keywords[i]+".","<teh>"+this.keywords[i]+".</teh>")).replace(this.keywords[i]+"s ","<teh>"+this.keywords[i]+"s</teh>")).replace(this.keywords[i]+"s.","<teh>"+this.keywords[i]+"s</teh>");return e}checkContextMode(e,t){var i=t.getAttribute("mode");return e.mode==i||null==i&&2==e.mode}addSpecToContextList(e,t,i){for(var n=null,s=0;s<this.contexts.length;s++)if(this.contexts[s].contextParent==t&&this.checkContextMode(this.contexts[s],e)){n=this.contexts[s];break}if(null==n){(n={}).id=this.contexts.length,n.contextParent=t,n.traits=i.map(String);var l=e.getAttribute("mode");n.mode=null!=l?parseInt(l):2,this.contexts.push(n)}else n.traits=n.traits.concat(i.map(String))}wrapTraits(e,t,i,n,s,l){var o=tUtils.newElement("div","traitwrapper");e.appendChild(o);for(var r=i;r<n;r++)r==parseInt(s)+parseInt(i)?o.innerHTML+=tUtils.newGW2Object("trait",t[r],l):o.innerHTML+=tUtils.newGW2Object("trait",t[r],l,"trait_unselected")}displaySpecialization(e,t){var i=gw2API.downloadedObjects["specialization_"+t];null==e.className&&(e.className="specialization");var n=e.classList.contains("noembed"),s=e.getAttribute("mode");n||(e.style.backgroundImage="url('"+i.background+"')");var l=e.getAttribute("selected_traits");null!=l&&(l=l.split(","));for(var o=i.minor_traits.concat(i.major_traits),r=[],a=0;a<o.length;a++)void 0===gw2API.downloadedObjects["trait_"+r[a]]&&r.push(o[a]);gw2API.getAPIObjects("trait",r).then((t=>{if(!n){e.innerHTML+=tUtils.newGW2Object("trait",o[0],s,"trait_minor"),e.innerHTML+=tUtils.newGW2Object("trait",o[1],s,"trait_minor"),e.innerHTML+=tUtils.newGW2Object("trait",o[2],s,"trait_minor"),this.wrapTraits(e,o,3,6,l[0],s),this.wrapTraits(e,o,6,9,l[1],s),this.wrapTraits(e,o,9,12,l[2],s);var r=e.getElementsByTagName("gw2object");r[2].parentNode.insertBefore(r[2],r[2].nextSibling.nextSibling.nextSibling),r[1].parentNode.insertBefore(r[1],r[1].nextSibling.nextSibling),r[0].parentNode.insertBefore(r[0],r[0].nextSibling)}var a=i.minor_traits.concat([o[3+parseInt(l[0])],o[6+parseInt(l[1])],o[9+parseInt(l[2])]]);this.addSpecToContextList(e,e.parentElement,a)}))}positionTooltip(){let e=0,t=0,i=gw2Tooltips.tooltip,n=document.getElementById("wpadminbar"),s=n?n.offsetHeight:0;e=gw2Tooltips.lastMouseX+i.offsetWidth+22>window.innerWidth?window.innerWidth-22-i.offsetWidth:gw2Tooltips.lastMouseX+16,t=gw2Tooltips.lastMouseY-i.offsetHeight-13-document.documentElement.scrollTop<0?s+6+document.documentElement.scrollTop:gw2Tooltips.lastMouseY-6-i.offsetHeight,i.style.transform="translate("+e+"px, "+t+"px)"}checkOverride(e,t){var i=e.indexOf("overrides");if(-1!=i){e.splice(i,1),t.splice(i,1);var n=e.indexOf("requires_trait");e.splice(n,1),t.splice(n,1);var s=e.indexOf("traited");e.splice(s,1),t.splice(s,1)}}handleSplitBalance(e,t){t=null==t?2:parseInt(t);for(var i=[],n=[],s=0;s<e.length;s++)if(null==n[s]){var l=[e[s]],o=Object.keys(e[s]),r=Object.values(e[s]);this.checkOverride(o,r);for(var a=0;a<e.length;a++)if(s!=a){var c=Object.keys(e[a]),d=Object.values(e[a]);if(this.checkOverride(c,d),JSON.stringify(o)==JSON.stringify(c)){for(var u=0,p=0,g=0;g<r.length;g++)if(r[g]!=d[g]&&"number"==typeof r[g])u++;else if(r[g]!=d[g]&&JSON.stringify(r[g])!=JSON.stringify(d[g])){p++;break}0==p&&u>=1&&(l.push(e[a]),n[a]=[s])}}l.length>1&&i.push(l)}else n[s].push(s);for(s=0;s<i.length;s++){i[s].length>3&&i.push(i[s].splice(i[s].length/2,i[s].length/2));for(a=0;a<i[s].length;a++)if(a!=t+(i[s].length<3&&2==t?-1:0))for(var h=0;h<e.length;h++)e[h]==i[s][a]&&(e.splice(h,1),h-=1)}return e}getContext(e){return null!=e.getAttribute("context")?{traits:[],id:parseInt(e.getAttribute("context")),mode:parseInt(e.getAttribute("mode"))}:null!=this.contexts[0]?this.contexts[0]:{traits:[],id:-1,mode:parseInt(e.getAttribute("mode"))}}generateTooltip(e,t,i,n,s){switch(e){case"skill":case"effect":return this.generateSkillTooltip(t,i,n,null,s);break;case"trait":return this.generateTraitTooltip(t,i,n,s);break;case"item":return this.generateItemTooltip(t,i,n,s);break;case"pet":return this.generatePetTooltip(t,i,s);break;case"pvp/amulet":return this.generatePvPAmuletTooltip(t,i,n,s);break}}getTooltip(e,t,i,n,s){if(null==n&&(n={traits:[],id:-1,mode:2},null!=i&&(n=this.getContext(i))),null==s&&(s=this.tooltip),null!=this.generatedTooltips[e+"_"+t+"_"+n.id])return new Promise(((i,s)=>{i(this.generatedTooltips[e+"_"+t+"_"+n.id])}));var l=gw2API.downloadedObjects[e+"_"+t];return void 0===l?new Promise(((l,o)=>{gw2API.getAPIObjects(e,t).then((o=>{l(this.generateTooltip(e,gw2API.downloadedObjects[e+"_"+t],n,i,s))}))})):this.generateTooltip(e,l,n,i,s)}generateSkillTooltip(e,t,i,n=null,s){var l,o=tUtils.newElement("div");return null==n&&(n=e),null!=e.next_chain&&(e.flip_skill=e.next_chain),null!=e.bundle_skills&&(null!=e.flip_skill&&(e.bundle_skills.unshift(e.flip_skill),delete e.flip_skill),gw2API.getAPIObjects("skill",e.bundle_skills).then((e=>{for(var l=[],o=0;o<e[0].length;o++)delete e[0][o].flip_skill,l.push(this.generateSkillTooltip(e[0][o],t,i,n,s));Promise.all(l).then((e=>{for(var l=0;l<e.length;l++)i==this.currentTooltip?(s.innerHTML=e[l]+s.innerHTML,this.generatedTooltips["skill_"+n.id+"_"+t.id]=s.innerHTML,this.positionTooltip()):(e[l].style.display="none",this.generatedTooltips["skill_"+n.id+"_"+t.id]=e[l]+this.generatedTooltips["skill_"+n.id+"_"+t.id]);s.offsetHeight>window.innerHeight/2&&e.length>1&&(gw2Tooltips.setUpCycler(i,s),i.classList.add("cycler"),i.setAttribute("title","Right-click to cycle through tooltips"))}))}))),void 0===e.flip_skill||gw2API.replacementSkills.includes(e.flip_skill)||null!=e.categories&&e.categories.includes("Signet")||(null==gw2API.downloadedObjects["skill_"+e.flip_skill]?gw2API.getAPIObjects("skill",e.flip_skill).then((l=>{this.generateSkillTooltip(gw2API.downloadedObjects["skill_"+e.flip_skill],t,i,n,s).then((e=>{i==this.currentTooltip?(s.innerHTML=e+s.innerHTML,this.generatedTooltips["skill_"+n.id+"_"+t.id]=s.innerHTML,this.positionTooltip()):this.generatedTooltips["skill_"+n.id+"_"+t.id]=e+this.generatedTooltips["skill_"+n.id+"_"+t.id]}))})):this.generateSkillTooltip(gw2API.downloadedObjects["skill_"+e.flip_skill],t,i,e,s).then((e=>{this.generatedTooltips["skill_"+n.id+"_"+t.id]=e+this.generatedTooltips["skill_"+n.id+"_"+t.id],setTimeout((function(){s.innerHTML=e+s.innerHTML,gw2Tooltips.positionTooltip()}),0)}))),(l=tUtils.newElement("div","tooltip")).setAttribute("data-id",e.id),1!=e.comboskill&&e.rootskill==e||(l.style.marginTop="5px"),new Promise(((i,n)=>{this.applyContext(e,t).then((n=>{o.appendChild(l),l.innerHTML+=this.processBasicTooltipInfo(e),this.processFacts(l,this.handleSplitBalance(this.orderFacts(n),t.mode),e),this.processDefianceDmg(l,n);var s=o.innerHTML;this.generatedTooltips["skill_"+e.id+"_"+t.id]=s,i(s)}))}))}generateTraitTooltip(e,t,i){var n=tUtils.newElement("div"),s=[];if(void 0!==e.skills)for(var l=0;l<e.skills.length;l++)e.skills[l].comboskill=!0,s.push(new Promise(((i,n)=>{this.generateSkillTooltip(e.skills[l],t).then((n=>{this.generatedTooltips["trait_"+e.id+"_"+t.id]=n,i(n)}))})));var o=tUtils.newElement("div","tooltip");return void 0!==e.skills&&(o.style.top="5px"),o.innerHTML+=this.processBasicTooltipInfo(e),new Promise(((i,l)=>{Promise.all(s).then((s=>{for(var l=0;l<s.length;l++)null!=s[l]&&(n.innerHTML=s[l]+n.innerHTML);null==e.facts&&(n.appendChild(o),this.generatedTooltips["trait_"+e.id+"_"+t.id]=n.innerHTML,i(n.innerHTML)),this.applyContext(e,t).then((s=>{n.appendChild(o),this.processFacts(o,this.handleSplitBalance(this.orderFacts(s),t.mode),e),this.processDefianceDmg(o,s);var l=n.innerHTML;this.generatedTooltips["trait_"+e.id+"_"+t.id]=l,i(l)}))}))}))}generateItemTooltip(e,t,i){let n=tUtils.newElement("div","tooltip");return new Promise(((s,l)=>{this.processItemDetails(e,i).then((i=>{n.innerHTML+=i;var l=this.highlightKeywords(n.outerHTML);this.generatedTooltips["item_"+e.id+"_"+t.id]=l,s(l)}))}))}processItemDetails(e,t){var i=[],n=document.createElement("tet"),s=document.createElement("teb");return s.innerHTML=tUtils.newImg(e.icon,"iconlarge")+"<span style='color:hsl(var(--hs-color-rarity-"+e.rarity.toLowerCase()+"))'>"+e.name+"</span>",n.appendChild(s),i.push(n.outerHTML),new Promise(((n,s)=>{var l=[];switch(e.type){case"Weapon":case"Back":case"Armor":case"Trinket":if(null!=e.details.defense&&0!=e.details.defense){var o=document.createElement("te");o.innerHTML="<br> <ted class='teditem'> Defense: "+e.details.defense+"</ted>",i.push(o.outerHTML)}var r=gw2API.getAttributes(e,t);l.push(r),r.then((t=>{for(var n=0;n<t.attributes.length;n++){var s=document.createElement("te");s.className="teitem";var l=0;l="Trinket"==e.type||"Back"==e.type?1==t.attributes[n].isMinor?Math.floor(t.attributes[n].multiplier*e.details.attribute_adjustment+1.25*gw2API.jewelMods[t.attributes.length-3][1]):Math.ceil(t.attributes[n].multiplier*e.details.attribute_adjustment+1.25*gw2API.jewelMods[t.attributes.length-3][0]):Math.round(t.attributes[n].multiplier*e.details.attribute_adjustment),s.innerHTML="<teg>+"+l+" "+this.correctItemStats[t.attributes[n].attribute]+"</teg>",i.push(s.outerHTML)}}));break;case"UpgradeComponent":switch(e.details.type){case"Rune":for(var a=e.details.bonuses,c=0;c<a.length;c++){(d=document.createElement("te")).className="teupgrade",d.innerHTML="("+(c+1)+") "+a[c],i.push(d.outerHTML)}break;case"Sigil":(d=document.createElement("te")).className="teupgrade",d.innerHTML=e.details.infix_upgrade.buff.description,i.push(d.outerHTML);break;case"Default":if(null!=e.details.bonuses)for(a=e.details.bonuses,c=0;c<a.length;c++){var d;(d=document.createElement("te")).className="teupgrade",d.innerHTML="("+(c+1)+") "+a[c],i.push(d.outerHTML)}else(d=document.createElement("te")).className="teupgrade",d.innerHTML=e.details.infix_upgrade.buff.description.replace("\n","<br>"),i.push(d.outerHTML);break}break;case"Consumable":var u=document.createElement("te");u.className="food";let n=e?.details?.description?e.details.description:e?.description?e.description:"",s=e?.details?.name?e.details.name:"",p=e?.details?.icon?e.details.icon:"",g=n?"<br>"+n.split("\n").join("<br>"):"";e.details?.duration_ms&&(s+="("+e.details.duration_ms/6e4+"m):"),g&&(s+=g),u.innerHTML=tUtils.newImg(p)+"<div>"+g+"</div>",i.push(u.outerHTML);break}Promise.all(l).then((()=>{n(i.join(""))}))}))}generatePetTooltip(e,t,i){var n=tUtils.newElement("div"),s=tUtils.newElement("div","tooltip_pet");return s.innerHTML+=e.name.replace("Juvenile ",""),s.innerHTML+="<br><te>"+e.description.replace("—Acht",' <em class="descr-author">- Acht</em>')+"</te>",s.style.marginTop="5px",new Promise(((i,l)=>{gw2API.getAPIObjects("skill",e.skills[0].id).then((l=>{this.generateSkillTooltip(gw2API.downloadedObjects["skill_"+e.skills[0].id],t).then((t=>{n.appendChild(s),n.innerHTML=t+n.innerHTML,this.generatedTooltips["pet_"+e.id]=n.innerHTML,i(n.innerHTML)}))}))}))}generatePvPAmuletTooltip(e,t,i,n){var s=tUtils.newElement("div","tooltip");return new Promise(((n,l)=>{var o=this.processAmuletDetails(e,i);s.innerHTML+=o;var r=this.highlightKeywords(s.outerHTML);this.generatedTooltips["pvp/amulet_"+e.id+"_"+t.id]=r,n(r)}))}processAmuletDetails(e,t){var i=[],n=document.createElement("tet"),s=document.createElement("teb");for(var l in s.innerHTML=tUtils.newImg(e.icon,"iconlarge")+"<tei style='color: hsl(var(--hs-color-rarity-exotic))'>"+e.name+"</tei>",n.appendChild(s),i.push(n.outerHTML),e.attributes){var o=document.createElement("te");o.className="teitem",o.innerHTML="<teg>+"+e.attributes[l]+" "+this.correctItemStats[l]+"</teg>",i.push(o.outerHTML)}return i.join("")}setUpCycler(e,t){gw2Tooltips.cycling=!0;var i=t.getElementsByClassName("tooltip");gw2Tooltips.baseTooltip=i[0].offsetHeight>window.innerHeight/2?1:2,gw2Tooltips.cyclePos=i.length-gw2Tooltips.baseTooltip;for(var n=0;n<i.length-gw2Tooltips.baseTooltip;n++)i[n].style.display="none"}cycleTooltips(){var e=gw2Tooltips.tooltip.getElementsByClassName("tooltip");if(1==gw2Tooltips.cycling){gw2Tooltips.cyclePos--,gw2Tooltips.cyclePos<0&&(gw2Tooltips.cyclePos=e.length-gw2Tooltips.baseTooltip),e[gw2Tooltips.cyclePos].style.display="";for(var t=0;t<e.length-gw2Tooltips.baseTooltip+1;t++)t==gw2Tooltips.cyclePos?e[t].style.display="":e[t].style.display="none";gw2Tooltips.positionTooltip()}}pushGTM(e){if(!window.dataLayer)return;let t=this.tooltip;1==gw2Tooltips.cycling&&(t=gw2Tooltips.tooltip.getElementsByClassName("tooltip")[gw2Tooltips.cyclePos]);const i=t.querySelector("tet teb")?.innerText??"";let n=null;switch(gw2Tooltips.currentTooltip.classList[0]){case"gw2objectembed":n="Description";break;default:n="Build";break}dataLayer.push({event:"tooltip",tooltip:i,tooltipId:e.getAttribute("objId")??0,tooltipLocation:n})}hookgw2Object(e){var t=e.getAttribute("type"),i=e.classList.contains("noembed");if("empty"!=t&&t&&void 0!==t){var n=e.getAttribute("objId"),s=this.tooltip,l=t+"_"+n,o=gw2API.downloadedObjects[l],r=[];null==o&&r.push(gw2API.getAPIObjects(t,n)),Promise.all(r).then((()=>{if("specialization"!=t||e.classList.contains("inline-skeleton")){if(!i&&o){if(e.innerHTML=tUtils.newImg(o.icon),e.classList.remove("inline-skeleton"),e.classList.contains("gw2objectembed")){e.innerHTML=e.innerHTML+o.name;var l=o.professions,r="Any";null!=l?"Bundle"!=o?.type&&(r=l[0]):null!=o.specialization&&(null!=gw2API.downloadedObjects["specialization_"+o.specialization]?r=gw2API.downloadedObjects["specialization_"+o.specialization].profession:gw2API.getAPIObjects("specialization",o.specialization).then((e=>{r=e[0].profession}))),r&&e.classList.add("gw2-color-"+r.toLowerCase()+"-light")}let t=document.createElement("a");t.setAttribute("href","https://wiki-en.guildwars2.com/wiki/Special:Search/"+o.name),t.setAttribute("target","_blank"),e.parentElement?.classList.contains("gw2-build-equipment-piece")||t.classList.add("inherit"),t.innerHTML=e.innerHTML,e.innerHTML=t.outerHTML}"specialization"!=e.getAttribute("type")&&(["mouseenter","keyup","touchend"].forEach((function(i){e.addEventListener(i,(function(l){gw2Tooltips.getTooltip(t,n,e).then((t=>{s.innerHTML=t,s.style.display="block",gw2Tooltips.pushGTM(e),s.offsetHeight>window.innerHeight/2&&s.querySelectorAll(".tooltip").length>1?("keyup"==i&&l.keyCode,("touchend"==i&&!gw2Tooltips.cycling||"touchend"!=i)&&gw2Tooltips.setUpCycler(e,s),l.target.classList.add("cycler"),l.target.setAttribute("title","Right-click to cycle through tooltips")):gw2Tooltips.cycling=!1,"keyup"==i&&(9==l.keyCode?(gw2Tooltips.lastMouseX=e.getBoundingClientRect().left,gw2Tooltips.lastMouseY=e.getBoundingClientRect().top+window.scrollY,gw2Tooltips.positionTooltip()):13===l.keyCode&&gw2Tooltips.cycleTooltips()),"touchend"==i&&(document.getSelection().removeAllRanges(),e.querySelector("a").style.pointerEvents="none")})),gw2Tooltips.currentTooltip=e}))})),["click","contextmenu","keyup","mouseenter"].forEach((function(t){e.addEventListener(t,(function(e){("click"==t||"contextmenu"==t||"keyup"==t&&13==e.keyCode)&&("contextmenu"==t&&gw2Tooltips.cycling&&e.preventDefault(),gw2Tooltips.cycleTooltips())}))})),e.addEventListener("mouseleave",(function(e){s.style.display="none"})),document.addEventListener("touchstart",(function(e){s.style.display="none"})),e.addEventListener("mousemove",(function(e){gw2Tooltips.lastMouseX=e.pageX,gw2Tooltips.lastMouseY=e.pageY,gw2Tooltips.positionTooltip()})))}else this.displaySpecialization(e,n)}))}}hookDocument(e,t){for(var i={skills:[],traits:[],items:[],specializations:[],pets:[],pvp_amulets:[]},n=e.getElementsByTagName("gw2object"),s=0;s<n.length;s++){var l=n[s].getAttribute("type"),o=n[s].getAttribute("objId");Number.isFinite(parseInt(o))&&i[l.replace("/","_")+"s"].push(o)}Promise.all([gw2API.getAPIObjects("skill",i.skills),gw2API.getAPIObjects("effect",i.skills),gw2API.getAPIObjects("trait",i.traits),gw2API.getAPIObjects("item",i.items),gw2API.getAPIObjects("specialization",i.specializations),gw2API.getAPIObjects("pet",i.pets),gw2API.getAPIObjects("pvp/amulet",i.pvp_amulets)]).then((function(){for(var e=0;e<n.length;e++)gw2Tooltips.hookgw2Object(n[e])})),e&&e.addEventListener("DOMNodeInserted",(function(e){"GW2OBJECT"==e.target.tagName&&gw2Tooltips.hookgw2Object(e.target),e.stopPropagation()}))}}var gw2Tooltips=new GW2Tooltips;gw2Tooltips.hookDocument(document,!0),window.addEventListener("jsnav",(function(){gw2Tooltips.hookDocument(document.getElementById("subpage"),!1)}));